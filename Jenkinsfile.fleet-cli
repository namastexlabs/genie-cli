// Jenkinsfile.fleet-cli — Update genie-cli on all fleet hosts
// Triggered by webhook on push to main of namastexlabs/genie-cli
//
// Post-update: restarts OpenClaw gateway on each host and broadcasts
// a system event so agents are notified about the new version.
pipeline {
    agent any
    options {
        timeout(time: 20, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '30'))
    }
    stages {
        stage('Prepare scripts') {
            steps {
                // ── Update script ──────────────────────────────────
                writeFile file: 'update-genie-cli.sh', text: '''\
#!/usr/bin/env bash
set -euo pipefail

HOST_LABEL="${1:-unknown}"
REPO_DIR="${HOME}/.local/share/genie-cli/repo"
BIN_DIR="${HOME}/.local/bin"
mkdir -p "${BIN_DIR}" "$(dirname "${REPO_DIR}")"

# ── Clone or update repo ───────────────────────────────
if [ ! -d "${REPO_DIR}/.git" ]; then
    rm -rf "${REPO_DIR}"
    git clone --branch main --depth 1 https://github.com/namastexlabs/genie-cli.git "${REPO_DIR}"
fi

cd "${REPO_DIR}"

# Nuke any local state that could block checkout
git reset --hard HEAD 2>/dev/null || true
git clean -fd 2>/dev/null || true

git remote set-url origin https://github.com/namastexlabs/genie-cli.git
git fetch origin +refs/heads/main:refs/remotes/origin/main
git checkout -B main refs/remotes/origin/main
git reset --hard refs/remotes/origin/main

# Run official installer in local mode (source-of-truth)
# This also repairs stale OpenClaw plugin paths in ~/.openclaw/openclaw.json
# and ensures prerequisites like jq/rg are installed (best-effort).
#
# NOTE: install.sh is interactive; in CI we default answers to yes.
export PATH="${HOME}/.bun/bin:${BIN_DIR}:/usr/local/bin:${PATH}"

# Use yes to avoid hanging on prompts in non-interactive Jenkins runs.

# Preflight: fail fast if required baseline tools are missing (avoid sudo prompts/hangs).
command -v git  >/dev/null 2>&1 || { echo "ERROR: missing prerequisite: git"; exit 3; }
command -v jq   >/dev/null 2>&1 || { echo "ERROR: missing prerequisite: jq"; exit 3; }
command -v rg   >/dev/null 2>&1 || { echo "ERROR: missing prerequisite: rg"; exit 3; }
command -v tmux >/dev/null 2>&1 || { echo "ERROR: missing prerequisite: tmux"; exit 3; }

# If a host requires sudo for prereqs, the installer will fail fast.
yes | bash "${REPO_DIR}/install.sh" --local "${REPO_DIR}" || { echo "ERROR: install.sh failed"; exit 5; }

GENIE_VER="$(genie --version 2>/dev/null || echo 'unknown')"
COMMIT="$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"

# ── Install codex via npm-global (nodesource node 24 pattern — no nvm) ────
NPM_GLOBAL="${HOME}/.npm-global"
mkdir -p "${NPM_GLOBAL}"
npm config set prefix "${NPM_GLOBAL}" 2>/dev/null || true
export PATH="${NPM_GLOBAL}/bin:${PATH}"

if ! command -v codex >/dev/null 2>&1; then
    echo "Installing codex..."
    npm install -g @openai/codex 2>&1 | tail -3
else
    echo "codex already installed: $(codex --version 2>/dev/null)"
fi

CODEX_VER="$(codex --version 2>/dev/null || echo 'unknown')"
echo "GENIE_OK: ${HOST_LABEL} | genie=${GENIE_VER} | codex=${CODEX_VER} | commit=${COMMIT}"
'''

                // ── Restart gateway script ─────────────────────────
                writeFile file: 'restart-gateway.sh', text: '''\
#!/usr/bin/env bash
set -euo pipefail

HOST_LABEL="${1:-unknown}"

# Find openclaw binary
OC=""
for p in /opt/genie/bin/openclaw "${HOME}/.local/bin/openclaw"; do
    [ -x "$p" ] && OC="$p" && break
done

if [ -z "$OC" ]; then
    echo "SKIP_RESTART: ${HOST_LABEL} — openclaw binary not found"
    exit 0
fi

echo "Restarting gateway on ${HOST_LABEL} via ${OC}..."
"$OC" gateway restart 2>&1 || echo "WARN: gateway restart returned non-zero on ${HOST_LABEL}"

# Wait a moment for the gateway to come up
sleep 3

# Verify gateway is running
"$OC" gateway status 2>&1 || echo "WARN: gateway status check failed on ${HOST_LABEL}"

echo "RESTART_OK: ${HOST_LABEL}"
'''

                // ── Broadcast script ───────────────────────────────
                // Sends a system event to the local gateway so agents
                // pick it up on their next heartbeat.
                writeFile file: 'broadcast-update.sh', text: '''\
#!/usr/bin/env bash
set -euo pipefail

HOST_LABEL="${1:-unknown}"
BUILD_URL="${2:-}"
BUILD_NUM="${3:-}"

# Get commit from local repo
REPO_DIR="${HOME}/.local/share/genie-cli/repo"
COMMIT="$(cd "${REPO_DIR}" 2>/dev/null && git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
GENIE_VER="$(genie --version 2>/dev/null || echo 'unknown')"

# Find openclaw binary
OC=""
for p in /opt/genie/bin/openclaw "${HOME}/.local/bin/openclaw"; do
    [ -x "$p" ] && OC="$p" && break
done

if [ -z "$OC" ]; then
    echo "SKIP_BROADCAST: ${HOST_LABEL} — openclaw binary not found"
    exit 0
fi

MSG="[Jenkins] genie-cli updated on ${HOST_LABEL} — version ${GENIE_VER}, commit ${COMMIT}, build #${BUILD_NUM}. Gateway restarted. ${BUILD_URL}"

echo "Broadcasting to ${HOST_LABEL}: ${MSG}"
"$OC" system event --text "$MSG" --mode next-heartbeat --json 2>&1 || echo "WARN: broadcast failed on ${HOST_LABEL}"

echo "BROADCAST_OK: ${HOST_LABEL}"
'''
            }
        }

        stage('Update genie-cli on Fleet') {
            parallel {
                stage('genie-os')  { steps { updateHost('genie@10.114.1.111', 'genie-os') } }
                stage('cegonha')   { steps { updateHost('genie@10.114.1.121', 'cegonha') } }
                stage('stefani')   { steps { updateHost('genie@10.114.1.124', 'stefani') } }
                stage('gus')       { steps { updateHost('genie@10.114.1.126', 'gus') } }
                stage('luis')      { steps { updateHost('genie@10.114.1.131', 'luis') } }
                stage('sampaio')   { steps { updateHost('genie@10.114.1.154', 'sampaio') } }
                stage('juice')     { steps { updateHost('openclaw@10.114.1.119', 'juice') } }
                stage('omni-prod') { steps { updateHost('omni@10.114.1.140', 'omni-prod') } }
                stage('felipe')    { steps { updateHost('genie@10.114.1.128', 'felipe') } }
            }
        }
    }
    post {
        success { echo 'genie-cli fleet update complete — all hosts updated' }
        failure { echo 'genie-cli fleet update had failures — check stage logs' }
    }
}

def updateHost(String sshTarget, String hostLabel) {
    sh """
        echo 'Updating genie-cli on ${hostLabel} (${sshTarget})...'
        cat update-genie-cli.sh | ssh -o BatchMode=yes -o ConnectTimeout=20 ${sshTarget} 'bash -s -- ${hostLabel}'
    """
}
